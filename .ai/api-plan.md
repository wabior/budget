# REST API Plan

## 1. Resources
- **Users**: Managed by Supabase Auth. Although not managed directly by our API, user information (id, email) is used for authentication and associating records.
- **Expenses**: Represents individual expenses. Mapped to the `expenses` table. Contains fields such as expense_id, user_id, name, amount, frequency, start_date, end_date, status, notes, type, created_at, and updated_at. Enforced validations include frequency bounds (0-12) and check constraint for one_time expenses (frequency must be 0).
- **Payments**: Represents payment records associated with expenses. Mapped to the `payments` table. Contains fields such as payment_id, expense_id, user_id, payment_amount, paid_amount, payment_date, payment_month, status, created_at, and updated_at. Defaults and ENUM validations (only unpaid or paid) are applied.

## 2. Endpoints
### 2.1. Expenses Endpoints
1. **Create Expense**
   - **Method**: POST
   - **URL**: `/api/expenses`
   - **Description**: Create a new expense record. On creation, system triggers automatic generation of associated payment records.
   - **Request JSON Example**:
     ```json
     {
       "user_id": "UUID",
       "name": "Electricity Bill",
       "amount": 120.50,
       "frequency": 1,
       "start_date": "2025-10-01",
       "end_date": "2025-12-31",
       "status": "active",
       "notes": "Monthly bill",
       "type": "regular"
     }
     ```
   - **Response JSON Example**:
     ```json
     {
       "expense_id": 123,
       "user_id": "UUID",
       "name": "Electricity Bill",
       "amount": 120.50,
       "frequency": 1,
       "start_date": "2025-10-01",
       "end_date": "2025-12-31",
       "status": "active",
       "notes": "Monthly bill",
       "type": "regular",
       "created_at": "2025-09-28T12:00:00Z",
       "updated_at": "2025-09-28T12:00:00Z"
     }
     ```
   - **Success Codes**: 201 Created
   - **Error Codes**: 400 Bad Request (validation error), 401 Unauthorized, 500 Internal Server Error

2. **Get Expense**
   - **Method**: GET
   - **URL**: `/api/expenses/{expense_id}`
   - **Description**: Retrieve a specific expense record by expense_id.
   - **Response JSON Example**: Same as above expense object.
   - **Success Codes**: 200 OK
   - **Error Codes**: 404 Not Found, 401 Unauthorized

3. **List Expenses**
   - **Method**: GET
   - **URL**: `/api/expenses`
   - **Description**: Retrieve a paginated list of expenses for the authenticated user. Supports filtering (by status, name) and sorting (by start_date, amount).
   - **Query Parameters**: 
     - `page` (default: 1)
     - `limit` (default: 10)
     - `sort_by` (e.g., start_date)
     - `status` (optional filter)
   - **Response JSON Example**:
     ```json
     {
       "expenses": [ { ... }, { ... } ],
       "pagination": {
         "page": 1,
         "limit": 10,
         "total": 50
       }
     }
     ```
   - **Success Codes**: 200 OK
   - **Error Codes**: 401 Unauthorized, 500 Internal Server Error

4. **Update Expense**
   - **Method**: PUT
   - **URL**: `/api/expenses/{expense_id}`
   - **Description**: Update an existing expense record. Note that editing an expense does not retroactively affect past payments.
   - **Request JSON Example**:
     ```json
     {
       "name": "Updated Expense Name",
       "amount": 130.75,
       "notes": "Updated note"
     }
     ```
   - **Response**: Updated expense object
   - **Success Codes**: 200 OK
   - **Error Codes**: 400 Bad Request, 404 Not Found, 401 Unauthorized

5. **Delete Expense**
   - **Method**: DELETE
   - **URL**: `/api/expenses/{expense_id}`
   - **Description**: Delete an expense record (and potentially cascade delete associated future payment records if business rules allow).
   - **Success Codes**: 204 No Content
   - **Error Codes**: 404 Not Found, 401 Unauthorized, 500 Internal Server Error

### 2.2. Payments Endpoints
1. **Create Payment** (Usually auto-generated by system when creating an expense, used primarily for manual adjustments):
   - **Method**: POST
   - **URL**: `/api/payments`
   - **Description**: Create a new payment record for an expense. Could be used in edge cases or adjustments.
   - **Request JSON Example**:
     ```json
     {
       "expense_id": 123,
       "user_id": "UUID",
       "payment_amount": 120.50,
       "payment_date": "2025-10-05",
       "payment_month": "2025-10-01"
     }
     ```
   - **Response JSON**: Newly created payment object, including default status ("unpaid").
   - **Success Codes**: 201 Created
   - **Error Codes**: 400 Bad Request, 401 Unauthorized, 404 Not Found

2. **Get Payment**
   - **Method**: GET
   - **URL**: `/api/payments/{payment_id}`
   - **Description**: Retrieve a specific payment record.
   - **Success Codes**: 200 OK
   - **Error Codes**: 404 Not Found, 401 Unauthorized

3. **List Payments**
   - **Method**: GET
   - **URL**: `/api/payments`
   - **Description**: Retrieve a list of payment records for the authenticated user with support for pagination, filtering by month, expense, and payment status.
   - **Query Parameters**: 
     - `page`, `limit`
     - `month`: filter by payment_month
     - `expense_id` (optional)
     - `status` (optional)
   - **Response JSON**: A paginated list of payment records
   - **Success Codes**: 200 OK
   - **Error Codes**: 401 Unauthorized, 500 Internal Server Error

4. **Update Payment**
   - **Method**: PUT
   - **URL**: `/api/payments/{payment_id}`
   - **Description**: Update payment details (e.g., marking as paid, adjusting payment amount if needed).
   - **Request JSON Example**:
     ```json
     {
       "paid_amount": 120.50,
       "status": "paid"
     }
     ```
   - **Success Codes**: 200 OK
   - **Error Codes**: 400 Bad Request, 404 Not Found, 401 Unauthorized

5. **Delete Payment**
   - **Method**: DELETE
   - **URL**: `/api/payments/{payment_id}`
   - **Description**: Delete a payment record (with caution â€“ may only allow deletion of future payments).
   - **Success Codes**: 204 No Content
   - **Error Codes**: 404 Not Found, 401 Unauthorized, 500 Internal Server Error

### 2.3. Month Management Endpoints (Business Functionality from PRD)
1. **Create First Month**
   - **Method**: POST
   - **URL**: `/api/months/first`
   - **Description**: Create the initial month for a user. This activates the interface changes as described in the PRD.
   - **Request JSON Example**:
     ```json
     {
       "start_date": "2025-10-01"
     }
     ```
   - **Response JSON**: Details of the created month and associated expenses for that month.
   - **Success Codes**: 201 Created
   - **Error Codes**: 400 Bad Request, 401 Unauthorized

2. **Generate New Month**
   - **Method**: POST
   - **URL**: `/api/months/new`
   - **Description**: Generate a new month by advancing one month from the latest existing month. The system automatically replicates expense listings (and for installment expenses, generates future payments).
   - **Response JSON Example**:
     ```json
     {
       "month": "2025-11-01",
       "generated_expenses": [ { ... } ]
     }
     ```
   - **Success Codes**: 201 Created
   - **Error Codes**: 400 Bad Request, 401 Unauthorized

## 3. Authentication and Authorization
- **Mechanism**: Uses Supabase Auth. All endpoints are secured, and the user is identified via their `auth.uid()`. 
- **Implementation Details**: 
  - The backend enforces row-level security (RLS) by ensuring that `user_id` in expenses and payments matches the result of `auth.uid()`.
  - Endpoints expect valid JWT tokens from the client. 
  - Standard HTTP status codes (401 for unauthorized, etc.) returned on invalid or missing credentials.

## 4. Validation and Business Logic
- **Validation Rules**:
  - Expense frequency must be between 0 and 12. For one_time expenses, frequency must be 0 (checked via DB constraints).
  - Payment status defaults to unpaid, only updated to paid when the entire amount is settled.
  - Dates must be in correct format and logical (e.g., start_date before end_date).
- **Business Logic**:
  - When creating an expense, the system automatically generates payment records classified by payment_month based on the expense frequency and type.
  - For installment expenses, the total amount is divided into installment amounts with each payment scheduled accordingly.
  - The "New Month" functionality automatically replicates current recurring expenses into the newly generated month.
  - Edits to expenses do not retroactively affect payments that have already been generated.

## 5. Additional Considerations
- **Pagination, Filtering, Sorting**: All list endpoints support pagination along with optional filtering (e.g., by status or month) and sorting to efficiently handle large datasets.
- **Error Handling**: Clear error messages are returned with each error code, with validation errors explicitly noted in the response.
- **Security Measures**: In addition to RLS provided by Supabase, common practices such as rate limiting and input sanitization should be implemented.
- **Assumptions**: 
  - The API design assumes that user authentication is managed centrally via Supabase Auth, and thus user registration and login endpoints are part of the Supabase platform, not the custom API.
  - Cascade deletion logic for expenses and payments is governed by business rules and should be carefully implemented if deletion is allowed.


